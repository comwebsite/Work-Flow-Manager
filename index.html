<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Work Flow Manager — Версия 4.0</title>
<style>
  :root{
    --bg:#071020;
    --glass-1: rgba(255,255,255,0.04);
    --glass-2: rgba(255,255,255,0.02);
    --accent-1: #0ea5ff;
    --accent-2: #6b21a8;
    --card-radius: 20px;
    --glass-border: rgba(255,255,255,0.06);
    --text: #e6f0ff;
    --muted: #9fb3d6;
    --shadow: 0 8px 30px rgba(2,6,23,0.7);
    font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
  }

  html,body{height:100%;margin:0;background:
    radial-gradient(1200px 600px at 10% 10%, rgba(14,165,255,0.06), transparent 6%),
    linear-gradient(180deg,#021028 0%, #04102a 50%, #020617 100%);
    color:var(--text);-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }

  /* Ensure footer space so cards don't overlap footer */
  body{padding-bottom:84px;box-sizing:border-box;}

  .app{
    max-width:1200px;margin:28px auto;padding:28px;box-sizing:border-box;
    display:grid;grid-template-columns: 1fr 420px;gap:20px;min-height:calc(100vh - 160px);
  }

  header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:12px}
  .logo{
    display:flex;align-items:center;gap:12px;
  }
  .logo .mark{
    width:56px;height:56px;border-radius:14px;
    background:linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.03), 0 6px 20px rgba(11,22,40,0.6);
    display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;
    border:1px solid var(--glass-border);
    transform:rotate(-8deg);
  }
  .logo .mark::after{
    content:"";position:absolute;inset:0;background:
    linear-gradient(120deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0));
    mix-blend-mode:overlay;
  }
  .logo h1{font-size:18px;margin:0;line-height:1;color:var(--text)}
  .logo p{margin:0;font-size:12px;color:var(--muted)}

  /* Cards */
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius: var(--card-radius);
    padding:18px;
    border:1px solid var(--glass-border);
    box-shadow: var(--shadow);
    backdrop-filter: blur(8px) saturate(120%);
    transition: transform .22s ease, box-shadow .22s ease;
    overflow:hidden;
  }
  .card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,6,23,0.8)}
  .card h2{margin:0 0 12px 0;font-size:16px;color:var(--text)}
  .muted{color:var(--muted);font-size:13px}

  /* Layout */
  .left{display:grid;grid-template-rows: auto 1fr;gap:20px;}
  .grid{
    display:grid;grid-template-columns:1fr 1fr;gap:20px;
  }

  /* Map card */
  .map-card{height:420px;padding:0;display:flex;flex-direction:column}
  .map-header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:space-between}
  .map-embed{flex:1;border-radius:0 0 var(--card-radius) var(--card-radius);overflow:hidden}
  .map-embed iframe{width:100%;height:100%;border:0;display:block}

  /* Timer */
  .timer-display{font-size:48px;font-weight:600;letter-spacing:1px;text-align:center;margin:8px 0;color:var(--text)}
  .timer-controls{display:flex;gap:8px;justify-content:center;margin-top:8px}
  .btn{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    color:var(--text);border:1px solid rgba(255,255,255,0.04);padding:10px 14px;border-radius:12px;cursor:pointer;
    transition:transform .12s ease, box-shadow .12s ease, background .12s;
  }
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));box-shadow:0 6px 18px rgba(11,22,40,0.6);color:#fff}
  .small{font-size:13px;padding:8px 10px;border-radius:10px}

  .timer-settings{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:10px}
  .timer-settings input[type="number"]{width:80px;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);text-align:center}

  /* Tasks */
  .tasks-list{display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto;padding-right:6px}
  .task-item{
    display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);
    background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  }
  .task-meta{display:flex;flex-direction:column;flex:1;min-width:0}
  .task-title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .task-sub{font-size:12px;color:var(--muted)}
  .priority-badge{padding:6px 8px;border-radius:10px;font-size:12px;color:#04102a}
  .prio-low{background:#c7f9cc}
  .prio-med{background:#fff3b0}
  .prio-high{background:#ffb4a2}
  .prio-urgent{background:#ff7b7b}

  /* Form */
  form .row{display:flex;gap:8px;align-items:center;margin-bottom:8px;min-width:0}
  form label{min-width:110px;color:var(--muted);font-size:13px}
  input[type="text"], input[type="datetime-local"], input[type="date"], input[type="time"], select, textarea{
    background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
    border:1px solid rgba(255,255,255,0.04);color:var(--text);padding:10px;border-radius:10px;flex:1;
    outline:none;min-width:0;
  }
  /* Ensure inputs inside .row don't overflow */
  .row input, .row select, .row textarea {flex:1;min-width:0;display:block;width:100%;}
  select{appearance:auto;padding-right:28px}
  textarea{min-height:100px;resize:vertical}

  /* Right column */
  .right{display:flex;flex-direction:column;gap:20px}
  .compact{padding:12px}

  /* Footer moved out of aside and centered */
  .site-footer{
    position:fixed;left:0;right:0;bottom:18px;margin:0 auto;max-width:1200px;padding:10px 28px;text-align:center;color:var(--muted);font-size:13px;
    pointer-events:none;
  }

  /* Responsive */
  @media (max-width:980px){
    .app{grid-template-columns:1fr; padding:18px}
    .grid{grid-template-columns:1fr}
    .map-card{height:320px}
    .site-footer{position:static;margin-top:18px;padding:18px 0;pointer-events:auto}
  }

  /* small touches */
  .logo-anim{animation:logoShine 6s linear infinite}
  @keyframes logoShine{0%{transform:rotate(-8deg) translateY(0)}50%{transform:rotate(-8deg) translateY(-3px)}100%{transform:rotate(-8deg) translateY(0)}}
  .fade{transition:opacity .25s ease}
  .hidden{display:none}
  .next-task{display:flex;align-items:center;gap:10px;justify-content:space-between}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="Work Flow Manager">
    <div class="left">
      <header>
        <div class="logo">
          <div class="mark logo-anim" aria-hidden="true">
            <svg width="36" height="36" viewBox="0 0 24 24" fill="none" style="filter:drop-shadow(0 6px 12px rgba(11,22,40,0.6))">
              <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#0ea5ff"/><stop offset="1" stop-color="#6b21a8"/></linearGradient></defs>
              <rect x="2" y="2" width="20" height="20" rx="5" fill="url(#g)"></rect>
              <path d="M7 12h10M7 8h10M7 16h6" stroke="rgba(255,255,255,0.9)" stroke-width="1.2" stroke-linecap="round"/>
            </svg>
          </div>
          <div>
            <h1>Work Flow Manager</h1>
            <p>Liquid glass • Полевая работа • Версия 4.0</p>
          </div>
        </div>
        <div class="muted">Версия 4.0</div>
      </header>

      <div class="card map-card" id="mapCard">
        <div class="map-header">
          <div>
            <strong>Интерактивная карта Windy</strong>
            <div class="muted" style="font-size:12px">Погодные слои — Windy embed (iframe)</div>
          </div>
          <div class="muted" style="font-size:13px">Карта в отдельной карточке</div>
        </div>
        <div class="map-embed" aria-hidden="false">
          <!-- Free Windy embed. При необходимости замените lat/lon/zoom или вставьте API-ключ в URL -->
          <iframe
            title="Windy map embed"
            src="https://embed.windy.com/embed2.html?lat=53.9&lon=27.5667&zoom=6&level=surface&overlay=wind&product=ecmwf&menu=&message=true&marker=&calendar=now&pressure=&type=map&detail=&detailLat=53.9&detailLon=27.5667"
            allowfullscreen
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
          ></iframe>
        </div>
      </div>

      <div class="grid">
        <div class="card" id="timerCard">
          <h2>Pomodoro таймер</h2>
          <div class="muted">Рабочий / Перерыв — настраиваемые интервалы</div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px">
            <div>
              <div class="timer-display" id="timerDisplay">25:00</div>
              <div class="muted" style="text-align:center" id="timerMode">Режим: Рабочий</div>
            </div>
            <div style="width:1px;background:rgba(255,255,255,0.02);height:120px;margin-left:12px"></div>
          </div>

          <div class="timer-settings" aria-hidden="false">
            <label class="muted">Работа (мин)</label>
            <input type="number" id="workMinutes" min="1" value="25" />
            <label class="muted">Перерыв (мин)</label>
            <input type="number" id="breakMinutes" min="1" value="5" />
          </div>

          <div class="timer-controls">
            <button class="btn primary" id="startBtn">Старт</button>
            <button class="btn" id="pauseBtn">Пауза</button>
            <button class="btn" id="resetBtn">Сброс</button>
          </div>
        </div>

        <div class="card" id="tasksCard">
          <h2>Задачи</h2>
          <div class="muted">Добавляйте задачи, указывайте приоритет и зависимости</div>

          <form id="taskForm" class="compact" onsubmit="return false;">
            <div style="display:flex;gap:8px;margin-bottom:8px">
              <input type="text" id="taskName" placeholder="Название задачи" required style="flex:1" />
              <select id="taskPriority" required>
                <option value="Средний">Средний</option>
                <option value="Низкий">Низкий</option>
                <option value="Высокий">Высокий</option>
                <option value="Срочно">Срочно</option>
              </select>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <select id="taskDependency" style="flex:1">
                <option value="">Без зависимости</option>
              </select>
              <button class="btn small" id="addTaskBtn">Добавить</button>
            </div>
          </form>

          <div style="margin-top:12px" class="tasks-list" id="tasksList" aria-live="polite"></div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center;justify-content:space-between">
            <div class="muted">Выбор следующей задачи учитывает приоритет и зависимости</div>
            <div style="display:flex;gap:8px">
              <button class="btn small" id="pickNextBtn">Выбрать следующую</button>
              <button class="btn small" id="clearDoneBtn">Удалить выполненные</button>
            </div>
          </div>

          <div style="margin-top:10px" id="nextTaskBox" class="next-task hidden">
            <div>
              <div class="muted">Следующая задача</div>
              <div id="nextTaskTitle" style="font-weight:700"></div>
            </div>
            <div>
              <button class="btn small" id="startNextBtn">Начать</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <aside class="right">
      <div class="card">
        <h2>Бланк наблюдений</h2>
        <div class="muted">Автозаполнение даты/времени, валидация полей</div>

        <form id="obsForm" action="https://formsubmit.co/communityofdevelopingcraftsmen@gmail.com" method="POST" class="compact">
          <input type="hidden" name="_captcha" value="false" />
          <input type="hidden" name="_subject" value="Наблюдение — Work Flow Manager 4.0" />

          <div class="row">
            <label for="obsDate">Дата</label>
            <input id="obsDate" name="Дата" type="date" required />
          </div>

          <!-- Исправлено: время теперь в той же строке (.row) и input имеет flex:1 -->
          <div class="row">
            <label for="obsTime">Время</label>
            <input id="obsTime" name="Время" type="time" required />
          </div>

          <div class="row">
            <label for="micro">Микрорайон</label>
            <input id="micro" name="Микрорайон" type="text" required />
          </div>
          <div class="row">
            <label for="temp">Температура</label>
            <input id="temp" name="Температура" type="text" inputmode="numeric" required />
          </div>
          <div class="row">
            <label for="hum">Влажность</label>
            <input id="hum" name="Влажность" type="text" inputmode="numeric" required />
          </div>
          <div class="row">
            <label for="weather">Погода</label>
            <select id="weather" name="Погода" required>
              <option>Ясно</option><option>Засуха</option><option>Туман</option><option>Облачно</option><option>Пасмурно</option><option>Дождь</option><option>Гроза</option><option>Град</option><option>Снег</option>
            </select>
          </div>
          <div class="row">
            <label for="wind">Ветер</label>
            <select id="wind" name="Ветер" required>
              <option>Нейтральный</option><option>Слабый</option><option>Легкий</option><option>Умеренный</option><option>Свежий ветер</option><option>Сильный ветер</option><option>Шторм</option><option>Ураган</option>
            </select>
          </div>
          <div class="row">
            <label for="kt">Kt</label>
            <input id="kt" name="Kt" type="text" inputmode="numeric" />
          </div>
          <div class="row">
            <label for="who">Выполняет работу</label>
            <input id="who" name="Выполняет работу" type="text" required />
          </div>
          <div class="row">
            <label for="device">Устройство</label>
            <select id="device" name="Устройство" required>
              <option>Смартфон</option><option>Планшет</option><option>Компьютер</option>
            </select>
          </div>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button class="btn" type="reset">Очистить</button>
            <button class="btn primary" id="submitObsBtn" type="submit">Отправить</button>
          </div>
        </form>
      </div>

    </aside>
  </div>

  <!-- Footer вынесен из aside и центрирован по ширине страницы -->
  <footer class="site-footer"></footer>

<script>
(function(){
  'use strict';

  document.addEventListener('DOMContentLoaded', function(){
    try {
      /* ---------------------------
         Pomodoro Timer
         --------------------------- */
      const startBtn = document.getElementById('startBtn');
      const pauseBtn = document.getElementById('pauseBtn');
      const resetBtn = document.getElementById('resetBtn');
      const timerDisplay = document.getElementById('timerDisplay');
      const timerModeLabel = document.getElementById('timerMode');
      const workMinutesInput = document.getElementById('workMinutes');
      const breakMinutesInput = document.getElementById('breakMinutes');

      if (!startBtn || !pauseBtn || !resetBtn || !timerDisplay) {
        console.warn('Timer elements missing, skipping timer init');
      } else {
        let intervalId = null;
        let remaining = 25 * 60;
        let isRunning = false;
        let isWorkMode = true;
        let preventMultipleStart = false;

        function formatTime(sec){
          const m = Math.floor(sec/60).toString().padStart(2,'0');
          const s = (sec%60).toString().padStart(2,'0');
          return m + ':' + s;
        }

        function updateDisplay(){
          timerDisplay.textContent = formatTime(remaining);
          timerModeLabel.textContent = 'Режим: ' + (isWorkMode ? 'Рабочий' : 'Перерыв');
        }

        function playBeep(){
          try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.type = 'sine';
            o.frequency.value = 880;
            g.gain.value = 0.0001;
            o.connect(g);
            g.connect(ctx.destination);
            o.start();
            g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
            g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 1.0);
            o.stop(ctx.currentTime + 1.05);
          } catch (e) {
            console.error('Audio error', e);
          }
        }

        function startTimer(){
          if (isRunning || preventMultipleStart) return;
          preventMultipleStart = true;
          isRunning = true;
          intervalId = setInterval(() => {
            try {
              remaining--;
              if (remaining <= 0) {
                playBeep();
                clearInterval(intervalId);
                intervalId = null;
                isRunning = false;
                // switch mode
                isWorkMode = !isWorkMode;
                const minutes = isWorkMode ? parseInt(workMinutesInput.value,10) || 25 : parseInt(breakMinutesInput.value,10) || 5;
                remaining = minutes * 60;
                updateDisplay();
                // auto-start next interval
                setTimeout(() => {
                  preventMultipleStart = false;
                  startTimer();
                }, 300);
              } else {
                updateDisplay();
              }
            } catch (e) {
              console.error('Timer tick error', e);
            }
          }, 1000);
          preventMultipleStart = false;
        }

        function pauseTimer(){
          if (intervalId) {
            clearInterval(intervalId);
            intervalId = null;
            isRunning = false;
          }
        }

        function resetTimer(){
          pauseTimer();
          isWorkMode = true;
          remaining = (parseInt(workMinutesInput.value,10) || 25) * 60;
          updateDisplay();
        }

        remaining = (parseInt(workMinutesInput.value,10) || 25) * 60;
        updateDisplay();

        startBtn.addEventListener('click', function(){
          try { startTimer(); } catch(e){ console.error(e); }
        });
        pauseBtn.addEventListener('click', function(){ try{ pauseTimer(); }catch(e){console.error(e)} });
        resetBtn.addEventListener('click', function(){ try{ resetTimer(); }catch(e){console.error(e)} });

        workMinutesInput.addEventListener('change', function(){
          if (!isRunning && isWorkMode) {
            remaining = (parseInt(this.value,10) || 25) * 60;
            updateDisplay();
          }
        });
        breakMinutesInput.addEventListener('change', function(){
          if (!isRunning && !isWorkMode) {
            remaining = (parseInt(this.value,10) || 5) * 60;
            updateDisplay();
          }
        });
      }

      /* ---------------------------
         Tasks with dependencies
         --------------------------- */
      const taskForm = document.getElementById('taskForm');
      const addTaskBtn = document.getElementById('addTaskBtn');
      const taskNameInput = document.getElementById('taskName');
      const taskPrioritySelect = document.getElementById('taskPriority');
      const taskDependencySelect = document.getElementById('taskDependency');
      const tasksList = document.getElementById('tasksList');
      const pickNextBtn = document.getElementById('pickNextBtn');
      const nextTaskBox = document.getElementById('nextTaskBox');
      const nextTaskTitle = document.getElementById('nextTaskTitle');
      const startNextBtn = document.getElementById('startNextBtn');
      const clearDoneBtn = document.getElementById('clearDoneBtn');

      let tasks = [];

      function refreshDependencyOptions(){
        if (!taskDependencySelect) return;
        const prev = taskDependencySelect.value || '';
        taskDependencySelect.innerHTML = '<option value="">Без зависимости</option>';
        tasks.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.id;
          opt.textContent = t.name;
          taskDependencySelect.appendChild(opt);
        });
        taskDependencySelect.value = prev;
      }

      function renderTasks(){
        if (!tasksList) return;
        tasksList.innerHTML = '';
        tasks.slice().sort((a,b)=> {
          const order = { 'Срочно':4, 'Высокий':3, 'Средний':2, 'Низкий':1 };
          const pa = order[a.priority]||0, pb = order[b.priority]||0;
          if (pa !== pb) return pb - pa;
          return a.createdAt - b.createdAt;
        }).forEach(t => {
          const el = document.createElement('div');
          el.className = 'task-item';
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = !!t.done;
          cb.addEventListener('change', function(){
            t.done = cb.checked;
            renderTasks();
          });

          const meta = document.createElement('div');
          meta.className = 'task-meta';
          const title = document.createElement('div');
          title.className = 'task-title';
          title.textContent = t.name;
          const sub = document.createElement('div');
          sub.className = 'task-sub';
          const dep = t.dependencyId ? (tasks.find(x=>x.id===t.dependencyId)?.name || '—') : 'Нет зависимости';
          sub.textContent = `Приоритет: ${t.priority} • Зависимость: ${dep}`;
          meta.appendChild(title);
          meta.appendChild(sub);

          const badge = document.createElement('div');
          badge.className = 'priority-badge';
          if (t.priority === 'Низкий') badge.classList.add('prio-low');
          if (t.priority === 'Средний') badge.classList.add('prio-med');
          if (t.priority === 'Высокий') badge.classList.add('prio-high');
          if (t.priority === 'Срочно') badge.classList.add('prio-urgent');
          badge.textContent = t.priority;

          const del = document.createElement('button');
          del.className = 'btn small';
          del.textContent = 'Удалить';
          del.addEventListener('click', function(){
            tasks = tasks.filter(x=>x.id !== t.id);
            tasks.forEach(x => { if (x.dependencyId === t.id) x.dependencyId = null; });
            refreshDependencyOptions();
            renderTasks();
          });

          el.appendChild(cb);
          el.appendChild(meta);
          el.appendChild(badge);
          el.appendChild(del);
          tasksList.appendChild(el);
        });
      }

      function addTask(name, priority, dependencyId){
        const id = 't' + Date.now() + Math.floor(Math.random()*1000);
        tasks.push({id, name, priority, dependencyId: dependencyId || null, done:false, createdAt: Date.now()});
        refreshDependencyOptions();
        renderTasks();
      }

      if (addTaskBtn && taskNameInput && taskPrioritySelect){
        addTaskBtn.addEventListener('click', function(e){
          e.preventDefault();
          const name = taskNameInput.value.trim();
          const pr = taskPrioritySelect.value;
          const dep = taskDependencySelect.value || null;
          if (!name) return;
          addTask(name, pr, dep);
          taskNameInput.value = '';
          taskPrioritySelect.value = 'Средний';
        });
      } else {
        console.warn('Task elements missing');
      }

      function pickNextTask(){
        const order = { 'Срочно':4, 'Высокий':3, 'Средний':2, 'Низкий':1 };
        const candidates = tasks.filter(t => !t.done && (!t.dependencyId || (tasks.find(x=>x.id===t.dependencyId) && tasks.find(x=>x.id===t.dependencyId).done)));
        if (candidates.length === 0) return null;
        candidates.sort((a,b) => {
          const pa = order[a.priority]||0, pb = order[b.priority]||0;
          if (pa !== pb) return pb - pa;
          return a.createdAt - b.createdAt;
        });
        return candidates[0];
      }

      if (pickNextBtn){
        pickNextBtn.addEventListener('click', function(){
          const next = pickNextTask();
          if (next){
            nextTaskTitle.textContent = next.name;
            nextTaskBox.classList.remove('hidden');
            nextTaskBox.dataset.taskId = next.id;
          } else {
            nextTaskTitle.textContent = 'Нет доступных задач';
            nextTaskBox.classList.remove('hidden');
            nextTaskBox.dataset.taskId = '';
          }
        });
      }

      if (startNextBtn){
        startNextBtn.addEventListener('click', function(){
          const id = nextTaskBox.dataset.taskId;
          if (!id) return;
          const t = tasks.find(x=>x.id===id);
          if (t) {
            t.done = true;
            renderTasks();
            nextTaskBox.classList.add('hidden');
          }
        });
      }

      if (clearDoneBtn){
        clearDoneBtn.addEventListener('click', function(){
          tasks = tasks.filter(t => !t.done);
          refreshDependencyOptions();
          renderTasks();
        });
      }

      /* ---------------------------
         Observation form validation & submission protection
         --------------------------- */
      const obsForm = document.getElementById('obsForm');
      const obsDate = document.getElementById('obsDate');
      const obsTime = document.getElementById('obsTime');
      const temp = document.getElementById('temp');
      const hum = document.getElementById('hum');
      const kt = document.getElementById('kt');
      const submitObsBtn = document.getElementById('submitObsBtn');

      if (obsDate) obsDate.value = new Date().toISOString().slice(0,10);
      if (obsTime) {
        const now = new Date();
        const hh = String(now.getHours()).padStart(2,'0');
        const mm = String(now.getMinutes()).padStart(2,'0');
        obsTime.value = hh + ':' + mm;
      }

      const allowedRe = /[0-9:\-\+\;\.,]/g;
      function sanitizeInput(el){
        if (!el) return;
        el.addEventListener('input', function(){
          const v = this.value;
          const filtered = (v.match(allowedRe) || []).join('');
          if (filtered !== v) {
            this.value = filtered;
          }
        });
      }
      sanitizeInput(temp);
      sanitizeInput(hum);
      sanitizeInput(kt);

      let obsSubmitting = false;
      if (obsForm){
        obsForm.addEventListener('submit', function(e){
          if (obsSubmitting) {
            e.preventDefault();
            return;
          }
          try {
            if (!obsDate.value || !obsTime.value || !document.getElementById('micro').value || !temp.value || !hum.value || !document.getElementById('who').value) {
              e.preventDefault();
              alert('Пожалуйста, заполните все обязательные поля.');
              return;
            }
            obsSubmitting = true;
            submitObsBtn.disabled = true;
            setTimeout(() => {
              obsSubmitting = false;
              submitObsBtn.disabled = false;
            }, 5000);
          } catch (err) {
            console.error('Form submit error', err);
          }
        });
      }

      refreshDependencyOptions();
      renderTasks();

    } catch (err) {
      console.error('Initialization error', err);
    }
  });
})();
</script>
</body>
</html>